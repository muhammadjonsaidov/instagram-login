<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Discovery - Instagram Business Discovery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .search-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .result-card {
            transition: transform 0.3s;
        }
        .result-card:hover {
            transform: translateY(-2px);
        }
        .loading-spinner {
            display: none;
        }
        .engagement-bar {
            height: 8px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fab fa-instagram me-2"></i>
                Instagram Business Discovery
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" th:href="@{/dashboard(userId=${user.id})}">
                    <i class="fas fa-tachometer-alt me-1"></i>
                    Dashboard
                </a>
                <a class="nav-link" th:href="@{/business-discovery/history(userId=${user.id})}">
                    <i class="fas fa-history me-1"></i>
                    History
                </a>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Search Section -->
    <section class="search-section py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8 text-center">
                    <h1 class="display-5 fw-bold mb-4">
                        <i class="fas fa-search me-3"></i>
                        Business Discovery
                    </h1>
                    <p class="lead mb-5">
                        Search and analyze any public Instagram business account to get detailed insights and statistics.
                    </p>
                    
                    <!-- Search Form -->
                    <div class="card border-0 shadow">
                        <div class="card-body p-4">
                            <form id="searchForm">
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-6">
                                        <label for="targetUsername" class="form-label text-start d-block">
                                            <i class="fab fa-instagram me-2"></i>
                                            Instagram Username
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">@</span>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="targetUsername" 
                                                   placeholder="Enter username (e.g., nike, cocacola)"
                                                   required>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="includeMedia">
                                            <label class="form-check-label" for="includeMedia">
                                                Include Recent Media
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-search me-2"></i>
                                            <span class="search-text">Search</span>
                                            <span class="loading-spinner">
                                                <i class="fas fa-spinner fa-spin"></i>
                                                Searching...
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Rate Limit Info -->
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="alert alert-info">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <strong th:text="${searchStats.remainingSearches}">0</strong>
                            <br><small>Searches Remaining</small>
                        </div>
                        <div class="col-md-3">
                            <strong th:text="${searchStats.recentSearches}">0</strong>
                            <br><small>Used This Hour</small>
                        </div>
                        <div class="col-md-3">
                            <strong th:text="${searchStats.successfulSearches}">0</strong>
                            <br><small>Total Successful</small>
                        </div>
                        <div class="col-md-3">
                            <strong>200</strong>
                            <br><small>Hourly Limit</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="container my-5">
        <div id="searchResults" style="display: none;">
            <!-- Results will be loaded here -->
        </div>
        
        <div id="errorMessage" style="display: none;">
            <!-- Error messages will be shown here -->
        </div>
    </div>

    <!-- Search Result Template -->
    <template id="resultTemplate">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card result-card border-0 shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fab fa-instagram me-2"></i>
                            Search Result
                        </h4>
                    </div>
                    <div class="card-body p-4">
                        <div class="row">
                            <!-- Profile Section -->
                            <div class="col-md-4 text-center mb-4">
                                <img id="profileImage" src="" alt="Profile Picture" 
                                     class="rounded-circle border border-3 border-primary mb-3"
                                     style="width: 120px; height: 120px; object-fit: cover;">
                                <h4 id="displayName" class="mb-1"></h4>
                                <p class="text-muted mb-2">
                                    <i class="fab fa-instagram me-1"></i>
                                    @<span id="username"></span>
                                </p>
                                <div id="verifiedBadge" class="mb-2" style="display: none;">
                                    <span class="badge bg-primary">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Verified
                                    </span>
                                </div>
                                <p id="accountType" class="badge bg-secondary"></p>
                            </div>
                            
                            <!-- Stats Section -->
                            <div class="col-md-8">
                                <div class="row text-center mb-4">
                                    <div class="col-4">
                                        <h3 id="followersCount" class="text-primary mb-1">0</h3>
                                        <small class="text-muted">Followers</small>
                                    </div>
                                    <div class="col-4">
                                        <h3 id="followingCount" class="text-success mb-1">0</h3>
                                        <small class="text-muted">Following</small>
                                    </div>
                                    <div class="col-4">
                                        <h3 id="mediaCount" class="text-info mb-1">0</h3>
                                        <small class="text-muted">Posts</small>
                                    </div>
                                </div>
                                
                                <!-- Biography -->
                                <div id="biographySection" class="mb-3">
                                    <h6>Biography</h6>
                                    <p id="biography" class="text-muted"></p>
                                </div>
                                
                                <!-- Website -->
                                <div id="websiteSection" class="mb-3" style="display: none;">
                                    <h6>Website</h6>
                                    <a id="website" href="" target="_blank" class="text-decoration-none"></a>
                                </div>
                                
                                <!-- Insights -->
                                <div id="insightsSection" style="display: none;">
                                    <h6>Account Insights</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Average Engagement Rate</small>
                                            <div class="d-flex align-items-center">
                                                <span id="engagementRate" class="me-2">0%</span>
                                                <div class="flex-grow-1">
                                                    <div class="engagement-bar bg-light">
                                                        <div id="engagementBar" class="engagement-bar bg-success" style="width: 0%;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Posts (Last 30 Days)</small>
                                            <h6 id="recentPosts">0</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Media -->
                        <div id="mediaSection" style="display: none;">
                            <hr>
                            <h5 class="mb-3">
                                <i class="fas fa-images me-2"></i>
                                Recent Media
                            </h5>
                            <div id="mediaGrid" class="row g-3">
                                <!-- Media items will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        const userId = /*[[${user.id}]]*/ 0;
        
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            performSearch();
        });

        function performSearch() {
            const username = document.getElementById('targetUsername').value.trim();
            const includeMedia = document.getElementById('includeMedia').checked;
            
            if (!username) {
                showError('Please enter a username');
                return;
            }
            
            // Show loading state
            const button = document.querySelector('button[type="submit"]');
            const searchText = button.querySelector('.search-text');
            const loadingSpinner = button.querySelector('.loading-spinner');
            
            searchText.style.display = 'none';
            loadingSpinner.style.display = 'inline';
            button.disabled = true;
            
            // Hide previous results
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            // Make API call
            const formData = new FormData();
            formData.append('userId', userId);
            formData.append('targetUsername', username);
            formData.append('includeMedia', includeMedia);
            
            fetch('/business-discovery/search', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
                return response.json();
            })
            .then(data => {
                displayResult(data);
            })
            .catch(error => {
                showError(error.message);
            })
            .finally(() => {
                // Reset button state
                searchText.style.display = 'inline';
                loadingSpinner.style.display = 'none';
                button.disabled = false;
            });
        }

        function displayResult(data) {
            const template = document.getElementById('resultTemplate');
            const clone = template.content.cloneNode(true);
            
            // Fill in the data
            clone.getElementById('profileImage').src = data.profilePictureUrl || '/images/default-avatar.png';
            clone.getElementById('displayName').textContent = data.name || 'N/A';
            clone.getElementById('username').textContent = data.username || 'N/A';
            clone.getElementById('followersCount').textContent = formatNumber(data.followersCount || 0);
            clone.getElementById('followingCount').textContent = formatNumber(data.followingCount || 0);
            clone.getElementById('mediaCount').textContent = formatNumber(data.mediaCount || 0);
            clone.getElementById('accountType').textContent = data.accountType || 'PERSONAL';
            
            if (data.isVerified) {
                clone.getElementById('verifiedBadge').style.display = 'block';
            }
            
            if (data.biography) {
                clone.getElementById('biography').textContent = data.biography;
            } else {
                clone.getElementById('biographySection').style.display = 'none';
            }
            
            if (data.website) {
                clone.getElementById('website').href = data.website;
                clone.getElementById('website').textContent = data.website;
                clone.getElementById('websiteSection').style.display = 'block';
            }
            
            // Show insights if available
            if (data.insights) {
                const insights = data.insights;
                clone.getElementById('engagementRate').textContent = (insights.averageEngagementRate || 0).toFixed(2) + '%';
                clone.getElementById('engagementBar').style.width = Math.min(100, (insights.averageEngagementRate || 0) * 10) + '%';
                clone.getElementById('recentPosts').textContent = insights.postsLast30Days || 0;
                clone.getElementById('insightsSection').style.display = 'block';
            }
            
            // Show media if available
            if (data.recentMedia && data.recentMedia.length > 0) {
                const mediaGrid = clone.getElementById('mediaGrid');
                data.recentMedia.slice(0, 6).forEach(media => {
                    const mediaItem = createMediaItem(media);
                    mediaGrid.appendChild(mediaItem);
                });
                clone.getElementById('mediaSection').style.display = 'block';
            }
            
            // Show the result
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(clone);
            resultsContainer.style.display = 'block';
        }

        function createMediaItem(media) {
            const div = document.createElement('div');
            div.className = 'col-md-4';
            
            const engagementRate = media.engagementRate ? media.engagementRate.toFixed(2) + '%' : 'N/A';
            
            div.innerHTML = `
                <div class="card border-0 shadow-sm">
                    <img src="${media.mediaUrl || ''}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="Media">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">
                                <i class="fas fa-heart text-danger"></i>
                                ${formatNumber(media.likeCount || 0)}
                            </small>
                            <small class="text-muted">
                                <i class="fas fa-comment text-primary"></i>
                                ${formatNumber(media.commentsCount || 0)}
                            </small>
                            <small class="text-muted">
                                ${engagementRate}
                            </small>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorMessage');
            errorContainer.innerHTML = `
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${message}
                        </div>
                    </div>
                </div>
            `;
            errorContainer.style.display = 'block';
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
    </script>
</body>
</html>